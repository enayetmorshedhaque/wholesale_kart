<?php
    session_start();
    if(!empty($_SESSION['user_token']) && !empty($_SESSION['user_name'])){
        $username =  $_SESSION['user_name'];
    }else{
        header('Location: index.html');
    }
?>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator | New Invoice</title>

    <!-- Favicon Link -->
    <link rel="icon" type="image/x-icon" href="./assets/images/favicon.ico">

    <!-- Fontawesome Kit -->
    <script src="https://kit.fontawesome.com/86bc96ac49.js" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS CDN Link -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">

    <!-- Datepicker CSS CDN Link -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="./assets/css/style.css">

    <style>
        .table>:not(caption)>*>* {
            border-bottom-width: 0;
            padding: .5rem 0;
        }

        th:last-child,
        td:last-child {
            text-align: center !important;
        }

        .form-control {
            padding: 1px 2px;
        }

        td input.form-control {
            width: 240px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard.html">
                <img src="./assets/images/logo.png" width="120">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo02"
                aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="generate-invoice.html">Generate Invoice</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="invoice-list.html">Invoice List</a>
                    </li>
                </ul>
                <div id="logoutOption">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="fa-solid fa-right-from-bracket"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <div class="container py-5">
        <form action="./assets/db/submitinvoice.php" method="POST" class="needs-validation" novalidate id="generateInvoiceForm"  charset="UTF-8">
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5><strong class="text-uppercase">Order Details</strong></h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control rounded-0" id="orderNumber"
                                    placeholder="Enter Order Number" name="orderNumber">
                                <label for="orderNumber" class="form-label">Enter Order Number</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control rounded-0 datepicker" id="orderDate"
                                    placeholder="Select Order Date" name="orderDate">
                                <label for="orderDate" class="form-label">Select Order Date</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5><strong class="text-uppercase">Invoice Details</strong></h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control rounded-0" id="invoiceNumber"
                                    placeholder="Enter Invoice Number" name="invoiceNumber">
                                <label for="invoiceNumber" class="form-label">Enter Invoice Number</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control rounded-0 datepicker" id="invoiceDate"
                                    placeholder="Select Invoice Date" name="invoiceDate">
                                <label for="invoiceDate" class="form-label">Select Invoice Date</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <h5>
                        <strong class="text-uppercase">Customer Details</strong>
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="number"
                                    class="form-control rounded-0"
                                    id="customerContact" placeholder="Enter Customer Number" name="customerContact">
                                <label for="customerContact" class="form-label">Enter Customer Number</label>
                                <div class="autocomplete">
                                    <div class="results">
                                        <ul id="contactSuggestionList"></ul>
                                    </div>
                                    <!-- <div class="clear"></div> -->
                                </div>
                                <div id="customerContactError"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control rounded-0 customerContactDetails"
                                    id="customerName" placeholder="Enter Customer Name" name="customerName">
                                <label for="customerName" class="form-label">Enter Customer Name</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                <textarea type="text" class="form-control rounded-0 customerContactDetails"
                                    id="customerAddress" placeholder="Enter Customer Address" name="customerAddress"></textarea>
                                <label for="customerAddress" class="form-label">Enter Customer Address</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <h5>
                <strong class="text-uppercase">add books</strong>
            </h5>
            <div class="table-responsive mb-3">
                <table class="table" id="invoiceTable">
                    <thead>
                        <tr>
                            <th>Book Name</th>
                            <th>Unit</th>
                            <th>Published Price</th>
                            <th>Sell Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="bookDetailsRow">
                        <tr class="bookDetails-form-group">
                            <td>
                                <input type="text" placeholder="Book Name (Required)" class="form-control rounded-0 bookDetail bookName"
                                    name="bookName[]" id="bookName">
                            </td>
                            <td>
                                <input type="number" placeholder="Unit (Required)" class="form-control rounded-0 bookDetail bookQuantity"
                                    name="bookQuantity[]" id="bookQuantity">
                            </td>
                            <td>
                                <input type="number" placeholder="Published Price (Required)"
                                    class="form-control rounded-0 bookDetail bookPublishedPrice" name="bookPublishedPrice[]" id="bookPublishedPrice">
                            </td>
                            <td>
                                <input type="number" placeholder="Selling Price (Required)"
                                    class="form-control rounded-0 bookDetail bookSellPrice" name="bookSellPrice[]" id="bookSellPrice">
                            </td>
                            <td>
                                <button class="btn btn-danger deleteThis">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <template id="template-row">
                    <tr class="bookDetails-form-group" id="template-row-input-fields">
                        <td>
                            <input type="text" placeholder="Book Name (Required)" class="form-control rounded-0 bookDetail bookName"
                                name="bookName[]" id="bookName">
                        </td>
                        <td>
                            <input type="number" placeholder="Unit (Required)" class="form-control rounded-0 bookDetail bookQuantity"
                                name="bookQuantity[]" id="bookQuantity">
                        </td>
                        <td>
                            <input type="number" placeholder="Published Price (Required)"
                                class="form-control rounded-0 bookDetail bookPublishedPrice" name="bookPublishedPrice[]"
                                id="bookPublishedPrice">
                        </td>
                        <td>
                            <input type="number" placeholder="Selling Price (Required)"
                                class="form-control rounded-0 bookDetail bookSellPrice" name="bookSellPrice[]" id="bookSellPrice">
                        </td>
                        <td>
                            <button class="btn btn-danger deleteThis">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </template>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="float-end">
                        <button class="btn btn-outline-primary" id="addNewRow">
                            <i class="fa-solid fa-plus"></i> Add Row
                        </button>
                    </div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="float-md-end">
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control rounded-0" id="vatAmount"
                                placeholder="Enter Vat If Applicable" name="vatAmount">
                            <label for="vatAmount" class="form-label">Enter Vat If Applicable</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row align-items-center">
                <h5>
                    <strong class="text-uppercase">Delivery Details</strong>
                </h5>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-0" id="selectCourier" name="selectCourier">
                            <option value="50">Sundarban(O/D) </option>
                            <option value="60">Steadfast(28685) (Inside Dhaka)</option>
                            <option value="100">Steadfast(28685) (Suburb & Outside Dhaka)</option>
                            <option value="0">Customize Courier</option>
                            <!-- <option value="70">redX (Inside Dhaka)</option>
                                                <option value="115">redX (Suburb)</option>
                                                <option value="150">redX (Outside Dhaka)</option> -->
                        </select>
                        <label for="selectCourier" class="form-label">Select Courier Company</label>
                    </div>
                </div>
                <div class="col-md-3 replacedFields">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control rounded-0" id="customCourierName"
                            placeholder="Enter Custom Courier Name" name="customCourierName">
                        <label for="customCourierName" class="form-label">Enter Custom Courier Name</label>
                    </div>
                </div>
                <div class="col-md-3 replacedFields">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control rounded-0" id="customCourierBill"
                            placeholder="Enter Custom Courier Bill" name="customCourierBill">
                        <label for="customCourierBill" class="form-label">Enter Custom Courier Bill</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating mb-3">
                        <select class="form-select rounded-0" id="selectPaymentOption" name="selectPaymentOption">
                            <option value="1">COD</option>
                            <option value="2">bKash</option>
                            <option value="3">Rocket</option>
                            <option value="4">Nagad</option>
                        </select>
                        <label for="selectPaymentOption" class="form-label">Select Payment Option</label>
                    </div>
                </div>
                <div class="col-md-3 changeableFields">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control rounded-0" id="totalWeight"
                            placeholder="Enter Total Weight in KG" name="totalWeight">
                        <label for="totalWeight" class="form-label">Enter Total Weight in KG</label>
                    </div>
                </div>
                <div class="col-md-3 changeableFields">
                    <div class="float-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="1" id="freeShipping" name="freeShipping">
                            <label class="form-check-label" for="freeShipping">
                                Free Shipping, No Courier Charge
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8"></div>
                <div class="col-md-4">
                    <div class="d-felx float-end">
                        <button type="generateInvoice" name="generateInvoice" class="btn btn-outline-success"
                            id="generateInvoice">Generate Pdf</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Bootstrap JS CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>

    <!-- Datepicker CDN Link -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

    <!-- jQuery Form Validation CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>

    <!-- jQuery Form Validation Additional Methods CDN Link -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>

    <!-- Page JS -->
    <script>
        $(document).ready(function () {

            // Auto Date Selection
            $(function () {
                $(".datepicker").datepicker({
                    dateFormat: "yy-mm-dd"
                }).datepicker("setDate", "today");
            });

            // POST Customize Courier Data
            $("select").on("change", function () {
                if (parseInt($("#selectCourier").find(":selected").val()) == 0) {
                    $(".changeableFields").css("display", "none");
                    $(".replacedFields").css("display", "block");
                } else {
                    $(".replacedFields").css("display", "none");
                    $(".changeableFields").css("display", "block");
                }
            });

            // Search Customer Using Contact Number
            $("#customerContact").on("keyup", function (e) {
                var mobile_number_input = $("#customerContact").val();

                if (!($.trim(mobile_number_input) === "")) {
                    $.ajax({
                        type: "POST",
                        url: "./assets/db/searchcustomer.php",
                        data: {
                            checking_customer_number: 1,
                            mobile_number_input: mobile_number_input,
                        },
                        dataType: "json",
                        success: function (response) {
                            var len = response.length;
                            $("#contactSuggestionList").empty();
                            for (var i = 0; i < len; i++) {
                                var customer_id = response[i]['customer_id'];
                                var customer_mobile = response[i]['customer_mobile'];

                                $("#contactSuggestionList").append("<li value='" + customer_id + "'>" + customer_mobile + "</li>");

                            }
                            // binding click event to li
                            $("#contactSuggestionList li").bind("click", function () {
                                setText(this);
                            });
                        },
                    });
                } else {
                    $("#contactSuggestionList").empty();
                    $("#customerContact").val("");
                    $("#customerName").val("");
                    $("#customerAddress").val("");
                }
            });

            // Automatically Set Order Number
            $.ajax({
                url: './assets/db/autogeneratenumber.php',
                type: 'post',
                data: {
                    check_increment_order_number: 1,
                },
                success: function (response) {
                    $("#orderNumber").val(response);
                }
            });

            // Automatically Set Invoice Number
            $.ajax({
                url: './assets/db/autogeneratenumber.php',
                type: 'post',
                data: {
                    check_increment_invoice_number: 1,
                },
                success: function (response) {
                    $("#invoiceNumber").val(response);
                }
            });

        });

        // Set Text to search box and get details
        function setText(element) {

            var contact_number = $(element).text();
            var contact_number_id = $(element).val();

            $("#customerContact").val(contact_number);
            $("#contactSuggestionList").empty();

            // Request User Details
            $.ajax({
                url: './assets/db/searchcustomer.php',
                type: 'post',
                data: {
                    set_customer_details: 1,
                    contact_number_id: contact_number_id
                },
                dataType: 'json',
                success: function (response) {

                    var len = response.length;
                    $("#customerName").empty();
                    $("#customerAddress").empty();
                    if (len > 0) {
                        var name = response[0]['customer_name'];
                        var address = response[0]['customer_address'];
                        $("#customerName").val(name);
                        $("#customerAddress").val(address);
                    }
                }

            });
        }
    </script>

    <!-- Invoice Form Validation JS -->
    <script src="./assets/js/invoice.form.validation.js"></script>

    <!-- CRUD Table Row JS -->
    <script src="./assets/js/add.or.remove.row.js"></script>

    <!-- Save To Local Storage JS -->
    <!-- <script src="./assets/js/save.to.localstorage.js"></script> -->

    <!-- Theme JS -->
    <script src="./assets/js/script.js"></script>

    <!-- Logout JS -->
    <script src="./assets/js/logout.js"></script>
</body>

</html>